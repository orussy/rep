<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Details - Store Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="sutomer-details.css">
</head>
<body>
    <div class="navbar">
        <div class="left"> <img src="img/store logo with one element on a white background.png" alt=""></div>
        
        <div class="right">
            <img src="img/bell-solid.svg" alt="Security">
            <img src="img/user-solid.svg" alt="Logout">
        </div>
    </div>
    <div class="sidebar">
        <ul>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="order.html">Orders</a></li>
            <li><a href="customers.html" class="active">Customers</a></li>
            <li class="sidebar-item">
                <a href="#" class="reports-toggle" data-submenu="reports1">Reports <i class="arrow-icon">▼</i></a>
                <ul class="submenu" id="reports1">
                    <li><a href="sales-report.html">Sales Report</a></li>
                    <li><a href="inventory-report.html">Inventory Report</a></li>
                    <li><a href="#">Business Report</a></li>
                    <li><a href="#">Analytics Report</a></li>
                </ul>
            </li>
            <li class="sidebar-item">
                <a href="#" class="reports-toggle" data-submenu="reports2">Inventory<i class="arrow-icon">▼</i></a>
                <ul class="submenu" id="reports2">
                    <li><a href="#">Items</a></li>
                    <li><a href="#">Categories</a></li>
                    <li><a href="#">Sub Categories</a></li>
                    <li><a href="#">Suppliers</a></li>
                    <li><a href="#">Purchase Orders</a></li>
                    <li><a href="#">Transfer Orders</a></li>
                    <li><a href="#">Inventory Count</a></li>
                </ul>
            </li>
            <li class="sidebar-item">
                <a href="#" class="reports-toggle" data-submenu="reports3">Manage<i class="arrow-icon">▼</i></a>
                <ul class="submenu" id="reports3">
                    <li><a href="#">Users</a></li>
                    <li><a href="#">Roles</a></li>
                    <li><a href="#">More</a></li>
                </ul>
            </li>
            <li class="sidebar-item">
              <a href="#" class="reports-toggle" data-submenu="reports4">Marketing<i class="arrow-icon">▼</i></a>
              <ul class="submenu" id="reports4">
                <li><a href="#">Loyalty</a></li>
                <li><a href="#">Discounts</a></li>
                <li><a href="#">Promocodes</a></li>
              </ul>
          </li>
        </ul>
    </div>
    
    <div class="content">
        <div class="customer-details-container">
            <a href="customers.html" class="back-button">
                ← Back to Customers
            </a>
            
            <div id="customerContent">
                <div class="loading">Loading customer details...</div>
            </div>
        </div>
    </div>
    
    <script>
        let currentCustomer = null;
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // Function to format date
        function formatDate(dateString) {
            if (!dateString || dateString === 'No orders') return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // Function to format currency
        function formatCurrency(amount) {
            if (!amount || amount === '0.00') return '0.00 EGP';
            return parseFloat(amount).toFixed(2) + ' EGP';
        }
        
        // Function to get status badge class
        function getStatusBadgeClass(status) {
            switch(status.toLowerCase()) {
                case 'active':
                    return 'status-active';
                case 'blocked':
                    return 'status-inactive';
                case 'pending':
                    return 'status-pending';
                default:
                    return 'status-pending';
            }
        }
        
        // Function to get order status class
        function getOrderStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'completed':
                    return 'status-completed';
                case 'pending':
                    return 'status-pending';
                case 'cancelled':
                    return 'status-cancelled';
                case 'processing':
                    return 'status-processing';
                default:
                    return 'status-pending';
            }
        }
        
        // Function to load customer details
        async function loadCustomerDetails() {
            const customerId = getUrlParameter('id');
            if (!customerId) {
                showError('Customer ID not provided');
                return;
            }
            
            try {
                const response = await fetch(`api/customer-details.php?id=${customerId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentCustomer = data.data;
                    displayCustomerDetails(currentCustomer);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error loading customer details:', error);
                showError(`Error loading customer details: ${error.message}`);
            }
        }
        
        // Function to display customer details
        function displayCustomerDetails(customer) {
            const container = document.getElementById('customerContent');
            
            const initials = (customer.f_name ? customer.f_name.charAt(0) : '') + 
                           (customer.l_name ? customer.l_name.charAt(0) : '');
            
            container.innerHTML = `
                <div class="customer-header">
                    <div class="customer-basic-info">
                        <div>
                            <div class="customer-avatar">${initials}</div>
                        </div>
                        <div class="customer-info-details">
                            <h1>${customer.f_name || 'N/A'} ${customer.l_name || ''}</h1>
                            <div class="customer-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Customer ID</span>
                                    <span class="meta-value">#${customer.id}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Email</span>
                                    <span class="meta-value">${customer.email || 'N/A'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Phone</span>
                                    <span class="meta-value">${customer.phone_no || 'N/A'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Status</span>
                                    <span class="meta-value">
                                        <span class="customer-status ${getStatusBadgeClass(customer.status)}">
                                            ${customer.status || 'Active'}
                                        </span>
                                    </span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Member Since</span>
                                    <span class="meta-value">${formatDate(customer.created_at)}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Last Order</span>
                                    <span class="meta-value">${customer.last_order_date === 'No orders' ? 'No orders' : formatDate(customer.last_order_date)}</span>
                                </div>
                            </div>
                            
                            <div class="customer-actions">
                                
                                ${String(customer.status).toLowerCase() === 'active' ? 
                                    `<button class=\"action-btn btn-deactivate\" onclick=\"toggleCustomerStatus(${customer.id}, 'blocked')\">Block</button>` :
                                    `<button class=\"action-btn btn-activate\" onclick=\"toggleCustomerStatus(${customer.id}, 'active')\">Activate</button>`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="customer-stats">
                        <div class="stat-card">
                            <div class="stat-number">${customer.total_orders || 0}</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${formatCurrency(customer.total_spent)}</div>
                            <div class="stat-label">Total Spent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${customer.avg_order_value ? formatCurrency(customer.avg_order_value) : '0.00 EGP'}</div>
                            <div class="stat-label">Avg Order Value</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${customer.days_since_last_order || 'N/A'}</div>
                            <div class="stat-label">Days Since Last Order</div>
                        </div>
                    </div>
                </div>
                
                <div class="customer-tabs">
                    <div class="tab-navigation">
                        <button class="tab-button active" onclick="showTab('orders')">Order History</button>
                        <button class="tab-button" onclick="showTab('profile')">Profile Details</button>
                        <button class="tab-button" onclick="showTab('addresses')">Addresses</button>
                        <button class="tab-button" onclick="showTab('activity')">Activity Log</button>
                    </div>
                    
                    <div id="orders-tab" class="tab-content active">
                        <h3>Order History</h3>
                        <div id="ordersContent">
                            <div class="loading">Loading orders...</div>
                        </div>
                    </div>
                    
                    <div id="profile-tab" class="tab-content">
                        <h3>Profile Details</h3>
                        <div class="profile-details">
                            <div class="meta-item">
                                <span class="meta-label">First Name</span>
                                <span class="meta-value">${customer.f_name || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Last Name</span>
                                <span class="meta-value">${customer.l_name || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Email</span>
                                <span class="meta-value">${customer.email || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Phone</span>
                                <span class="meta-value">${customer.phone_no || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Date of Birth</span>
                                <span class="meta-value">${customer.dob || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Gender</span>
                                <span class="meta-value">${customer.gender || 'N/A'}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Account Status</span>
                                <span class="meta-value">
                                    <span class="customer-status ${getStatusBadgeClass(customer.status)}">
                                        ${customer.status || 'Active'}
                                    </span>
                                </span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Created At</span>
                                <span class="meta-value">${formatDate(customer.created_at)}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Last Updated</span>
                                <span class="meta-value">${customer.updated_at ? formatDate(customer.updated_at) : 'N/A'}</span>
                            </div>
                            <div style="margin-top:16px;">
                                <button class="action-btn btn-edit" onclick="openEditModal(${customer.id})">Edit Profile</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="addresses-tab" class="tab-content">
                        <h3>Addresses</h3>
                        <div id="addressesContent">
                            <div class="loading">Loading addresses...</div>
                        </div>
                    </div>
                    
                    <div id="activity-tab" class="tab-content">
                        <h3>Activity Log</h3>
                        <div id="activityContent">
                            <div class="loading">Loading activity...</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load tab content
            loadOrders(customer.id);
            loadAddresses(customer.id);
            loadActivity(customer.id);
        }
        
        // Function to show tab content
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        // Function to load orders
        async function loadOrders(customerId) {
            try {
                const response = await fetch(`api/customer-orders.php?id=${customerId}`);
                const data = await response.json();
                
                const ordersContent = document.getElementById('ordersContent');
                
                if (data.status === 'success' && data.data.length > 0) {
                    let html = `
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Payment Method</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.data.forEach(order => {
                        html += `
                            <tr>
                                <td>#${order.id}</td>
                                <td>${formatDate(order.created_at)}</td>
                                <td>
                                    <span class="order-status ${getOrderStatusClass(order.status)}">
                                        ${order.status}
                                    </span>
                                </td>
                                <td>${order.items_count || 0} items</td>
                                <td>${formatCurrency(order.total_amount)}</td>
                                <td>${order.payment_method || 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    ordersContent.innerHTML = html;
                } else {
                    ordersContent.innerHTML = '<div class="no-data">No orders found for this customer</div>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersContent').innerHTML = 
                    '<div class="error">Error loading orders</div>';
            }
        }
        
        // Function to load addresses
        async function loadAddresses(customerId) {
            try {
                const response = await fetch(`api/customer-addresses.php?id=${customerId}`);
                const data = await response.json();
                
                const addressesContent = document.getElementById('addressesContent');
                
                if (data.status === 'success' && data.data.length > 0) {
                    let html = '<div class="address-details">';
                    
                    data.data.forEach(address => {
                        html += `
                            <div class="address-item">
                                <div class="address-type">${address.type || 'Address'}</div>
                                <div class="address-text">
                                    ${address.street_address || ''}<br>
                                    ${address.city || ''}, ${address.state || ''} ${address.postal_code || ''}<br>
                                    ${address.country || ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    addressesContent.innerHTML = html;
                } else {
                    addressesContent.innerHTML = '<div class="no-data">No addresses found for this customer</div>';
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
                document.getElementById('addressesContent').innerHTML = 
                    '<div class="error">Error loading addresses</div>';
            }
        }
        
        // Function to load activity
        async function loadActivity(customerId) {
            try {
                const response = await fetch(`api/customer-activity.php?id=${customerId}`);
                const data = await response.json();
                
                const activityContent = document.getElementById('activityContent');
                
                if (data.status === 'success' && data.data.length > 0) {
                    let html = '<div class="activity-list">';
                    
                    data.data.forEach(activity => {
                        html += `
                            <div class="activity-item">
                                <div class="activity-time">${formatDate(activity.created_at)}</div>
                                <div class="activity-description">${activity.description}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    activityContent.innerHTML = html;
                } else {
                    activityContent.innerHTML = '<div class="no-data">No activity found for this customer</div>';
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('activityContent').innerHTML = 
                    '<div class="error">Error loading activity</div>';
            }
        }
        
        // Function to show error
        function showError(message) {
            document.getElementById('customerContent').innerHTML = `
                <div class="error">${message}</div>
            `;
        }
        
        // Function to edit customer
        function editCustomer(customerId) {
            // Redirect to edit customer page or open modal
            alert('Edit customer functionality would be implemented here');
        }
        
        // Function to toggle customer status
        async function toggleCustomerStatus(customerId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this customer?`)) {
                return;
            }
            
            try {
                const response = await fetch('api/update-customer-status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        status: newStatus
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Reload customer details
                    loadCustomerDetails();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error updating customer status:', error);
                alert(`Error updating customer status: ${error.message}`);
            }
        }
        
        // Load customer details when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomerDetails();
        });
    </script>
    <script>
    function openEditModal(id){
        const c = currentCustomer || {};
        const formHtml = `
        <div id="editModal" class="modal" style="display:flex;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;">
          <div class="modal-content" style="background:#fff;padding:16px;border-radius:8px;max-width:520px;width:100%;">
            <h3 style="margin-top:0;">Edit Customer</h3>
            <div class="form-row"><label>First Name</label><input id="ef_name" value="${c.f_name||''}"></div>
            <div class="form-row"><label>Last Name</label><input id="el_name" value="${c.l_name||''}"></div>
            <div class="form-row"><label>Email</label><input id="eemail" value="${c.email||''}"></div>
            <div class="form-row"><label>Phone</label><input id="ephone" value="${c.phone_no||''}"></div>
            <div class="form-row"><label>Gender</label><input id="egender" value="${c.gender||''}"></div>
            <div class="form-row"><label>Birthdate</label><input id="ebirth" value="${c.dob||''}"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                <button onclick="closeEditModal()">Cancel</button>
                <button onclick="submitEdit(${id})">Save</button>
            </div>
          </div>
        </div>`;
        const wrap = document.createElement('div');
        wrap.innerHTML = formHtml;
        document.body.appendChild(wrap.firstElementChild);
    }
    function closeEditModal(){
        const m = document.getElementById('editModal');
        if (m) m.remove();
    }
    async function submitEdit(id){
        const payload = {
            id,
            f_name: document.getElementById('ef_name').value.trim(),
            l_name: document.getElementById('el_name').value.trim(),
            email: document.getElementById('eemail').value.trim(),
            phone_no: document.getElementById('ephone').value.trim(),
            gender: document.getElementById('egender').value.trim(),
            birthdate: document.getElementById('ebirth').value.trim()
        };
        try{
            const res = await fetch('api/update-customer.php',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            const out = await res.json();
            if(out.status !== 'success') throw new Error(out.message||'Failed');
            closeEditModal();
            loadCustomerDetails();
        }catch(e){
            alert('Update failed: '+ e.message);
        }
    }
    </script>
    
    <script src="script.js"></script>
</body>
</html>
